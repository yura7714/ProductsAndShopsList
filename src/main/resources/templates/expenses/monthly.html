<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Расходы по месяцам</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div th:replace="~{fragments :: navbar}"></div>

<div class="container mt-4">
    <div sec:authorize="hasRole('ROLE_READ_ONLY')">
        <p class="text-body mb-3 text-center">Для получения доступа к разделу обратитесь к администратору</p>
    </div>
    <div sec:authorize="!hasRole('ROLE_READ_ONLY')" class="row">
        <div class="col-12">
            <h2 class="text-primary mb-4">Расходы по месяцам</h2>

            <!-- Выбор года -->
            <div class="card mb-4">
                <div class="card-body">
                    <form th:action="@{/expenses/monthly}" method="get" class="row g-3 align-items-center">
                        <div class="col-auto">
                            <label for="year" class="form-label fw-semibold">Год:</label>
                        </div>
                        <div class="col-auto">
                            <select name="year" id="year" class="form-select" onchange="this.form.submit()">
                                <option th:each="y : ${#numbers.sequence(currentYear-5, currentYear)}"
                                        th:value="${y}"
                                        th:text="${y}"
                                        th:selected="${y == selectedYear}">
                                </option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Общая статистика -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Общие расходы за год</h5>
                            <h2 class="card-text" th:text="${#numbers.formatDecimal(totalYear, 1, 2) + ' ₽'}"></h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Средний расход в месяц</h5>
                            <h2 class="card-text"
                                th:text="${#numbers.formatDecimal(totalYear / 12, 1, 2) + ' ₽'}">
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Таблица расходов -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Детализация по месяцам</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>Месяц</th>
                                <th>Сумма</th>
                                <th>Процент от общего</th>
                                <th>Прогресс</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="expense : ${monthlyExpenses}">
                                <td th:text="${expense.monthName}"></td>
                                <td>
                                    <!-- Простая проверка на 0 -->
                                    <span th:if="${expense.total == 0}">0 ₽</span>
                                    <span th:if="${expense.total > 0}"
                                            th:text="${#numbers.formatDecimal(expense.total, 1, 2) + ' ₽'}">
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${totalYear > 0}">
                                        <span th:if="${(expense.total / totalYear) * 100 == 0}">0 %</span>
                                        <span th:if="${(expense.total / totalYear) * 100 > 0}"
                                              th:text="${#numbers.formatDecimal((expense.total / totalYear) * 100, 1, 2) + ' %'}">
                                        </span>
                                    </span>
                                    <span th:if="${totalYear == 0}">0 %</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar"
                                             th:classappend="${expense.total > 0} ? 'bg-success' : ''"
                                             th:style="'width: ' + ${totalYear > 0 ? (expense.total / totalYear) * 100 : 0} + '%;'"
                                             role="progressbar">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>